{% extends 'layouts/base.html' %}
{% import 'components/cards.html' as cards %}
{% import 'components/icons.html' as icons %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
        <h2 class="text-xl font-bold tracking-tight">Visão Geral</h2>
        <!-- Month Navigator (Compact) -->
        <div class="flex items-center bg-secondary/50 rounded-md border border-border p-0.5">
            <a href="{{ url_for('dashboard', month=prev_month) }}" class="btn btn-ghost btn-sm btn-icon h-7 w-7" title="Mês Anterior">
                {{ icons.icon('caret-left', class='w-4 h-4') }}
            </a>
            <span class="text-sm font-medium text-foreground min-w-[100px] text-center capitalize px-2">
                {{ current_date | month_br }}
            </span>
            <a href="{{ url_for('dashboard', month=next_month) }}" class="btn btn-ghost btn-sm btn-icon h-7 w-7" title="Próximo Mês">
                {{ icons.icon('caret-right', class='w-4 h-4') }}
            </a>
        </div>
        {% if current_date.strftime('%Y-%m') != now().strftime('%Y-%m') %}
        <a href="{{ url_for('dashboard') }}" class="text-xs font-medium text-primary hover:underline">
            Voltar para hoje
        </a>
        {% endif %}
    </div>

    <div class="flex items-center gap-2">
         <a href="{{ url_for('settings') }}" class="btn btn-outline btn-sm">
            {{ icons.icon('gear', class='mr-2') }} Orçamento
        </a>
        <a href="{{ url_for('expenses') }}" class="btn btn-primary btn-sm shadow-sm">
            {{ icons.icon('plus', class='mr-2') }} Despesa
        </a>
    </div>
</div>

<!-- HERO SECTION: Consolidated Financial Health (Compact Version) -->
<div class="card mb-6 shadow-sm">
    <div class="card-content p-6">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Main Stat: Remaining -->
            <div class="flex-1 min-w-[240px]">
                <p class="text-xs font-semibold text-muted uppercase tracking-wider mb-1">Saldo Disponível</p>
                <div class="stat-hero-value mb-1 {% if remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ remaining | currency }}
                </div>
                <div class="flex items-center gap-2 text-sm text-muted">
                    <span>Meta: <strong>{{ budget | currency }}</strong></span>
                    <span class="text-border">|</span>
                    <span>Gasto: <strong>{{ total_spent | currency }}</strong></span>
                </div>
            </div>

            <!-- Divider (Desktop) -->
            <div class="hidden lg:block w-px bg-border self-stretch"></div>

            <!-- Insights Grid (Compact) -->
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-6">
                 <!-- 1. Vs Previous -->
                <div>
                    <p class="text-[10px] text-muted uppercase font-bold tracking-wider mb-1">vs. Mês Anterior</p>
                    <div class="flex items-baseline gap-1.5">
                        <span class="text-lg font-bold {{ 'text-danger' if delta_prev_val > 0 else 'text-success' }}">
                            {% if delta_prev_val > 0 %}+{% endif %}{{ delta_prev_val | currency }}
                        </span>
                    </div>
                    {% if prev_month_total > 0 %}
                    <p class="text-xs text-muted">
                        <span class="{{ 'text-danger' if delta_prev_val > 0 else 'text-success' }}">
                            {{ delta_prev_pct | round(1) }}%
                        </span> sobre anterior
                    </p>
                    {% else %}
                    <p class="text-xs text-muted">Sem histórico</p>
                    {% endif %}
                </div>

                <!-- 2. Trend -->
                <div>
                    <p class="text-[10px] text-muted uppercase font-bold tracking-wider mb-1">Tendência</p>
                    <div class="flex items-center h-[28px]">
                        {% if trend == 'up' %}
                            <div class="flex items-center gap-1.5 text-danger font-bold text-sm">
                                {{ icons.icon('trend-up', class='w-4 h-4') }} Acelerando
                            </div>
                        {% elif trend == 'down' %}
                             <div class="flex items-center gap-1.5 text-success font-bold text-sm">
                                {{ icons.icon('trend-down', class='w-4 h-4') }} Economizando
                            </div>
                        {% else %}
                            <div class="flex items-center gap-1.5 text-muted font-bold text-sm">
                                {{ icons.icon('minus', class='w-4 h-4') }} Estável
                            </div>
                        {% endif %}
                    </div>
                     <p class="text-xs text-muted">vs. média trimestral</p>
                </div>

                <!-- 3. Progress Bar (Mini) -->
                <div class="flex flex-col justify-center">
                     <div class="flex justify-between text-[10px] font-bold text-muted mb-1.5 uppercase tracking-wide">
                        <span>Consumo da Meta</span>
                        <span>{{ percentage | round(0) }}%</span>
                    </div>
                    <div class="progress-bg h-2">
                        <div class="progress-fill {% if remaining < 0 %}danger{% else %}success{% endif %}" style="width: {{ [percentage, 100] | min }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ASYMMETRIC GRID: History (Primary) + Breakdown (Secondary) -->
<div class="grid grid-dashboard gap-6 items-start">
    
    <!-- LEFT: Recent Transactions (Wider) -->
    <div class="card shadow-sm overflow-hidden">
        <div class="card-header flex-row items-center justify-between py-3 px-4 border-b border-border bg-secondary/20">
            <h3 class="font-semibold text-sm">Últimas Transações</h3>
            <a href="{{ url_for('expenses') }}" class="text-xs font-medium text-primary hover:underline">Ver todas &rarr;</a>
        </div>
        <div class="table-container">
            <table class="table table-compact w-full">
                <tbody>
                    {% for expense in expenses %}
                    <tr class="group">
                        <td class="w-[120px] text-muted font-variant-numeric tabular-nums text-xs">
                            {{ expense.expense_date | date_br }}
                        </td>
                        <td class="max-w-[200px]">
                            <div class="font-medium text-sm truncate text-foreground/90 group-hover:text-foreground">
                                {{ expense.description }}
                            </div>
                        </td>
                        <td class="w-[1px] whitespace-nowrap">
                            <span class="badge badge-secondary text-[10px] uppercase tracking-wide font-semibold text-muted-foreground">
                                {{ expense.category }}
                            </span>
                        </td>
                        <td class="text-right font-medium text-sm font-variant-numeric tabular-nums w-[120px]">
                            {{ expense.amount | currency }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-12 text-muted text-sm">
                            Nenhuma movimentação neste mês.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- RIGHT: Category Breakdown (Narrower) -->
    <div class="card shadow-sm h-full">
        <div class="card-header border-b border-border py-3 px-4 bg-secondary/20">
            <h3 class="font-semibold text-sm">Por Categoria</h3>
        </div>
        <div class="card-content p-4 flex flex-col gap-3">
            {% for category, amount in category_stats.items() %}
            <div class="group">
                <div class="flex items-center justify-between text-xs mb-1.5">
                    <span class="font-medium text-foreground/80 group-hover:text-foreground">{{ category }}</span>
                    <span class="font-variant-numeric tabular-nums font-semibold">{{ amount | currency }}</span>
                </div>
                <div class="progress-bg h-1.5 bg-secondary">
                    <div class="progress-fill bg-foreground/80 group-hover:bg-foreground transition-all" style="width: {{ (amount / total_spent * 100) if total_spent > 0 else 0 }}%"></div>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted text-sm py-8">Sem dados.</div>
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}