services:
  metrics-app:
    build:
      context: .
      network: host
    container_name: smc
    environment:
      - APP_NAME=system_metrics_collector
      - APP_VERSION=1.0.0
      - ENVIRONMENT=production
      - METRICS_INTERVAL_SECONDS=30
      - METRICS_OUTPUT_FORMAT=json
      - METRICS_OUTPUT_FILE=/app/output/metrics.json
      - COLLECT_CPU_METRICS=true
      - COLLECT_MEMORY_METRICS=true
      - COLLECT_DISK_METRICS=true
      - COLLECT_NETWORK_METRICS=true
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - VICTORIALOGS_URL=http://localhost:9428
      - ENABLE_VICTORIALOGS=true
      - ENABLE_OTLP=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
    network_mode: host
    volumes:
      - ./output:/app/output
    restart: unless-stopped
    depends_on:
      - victorialogs
      - otel-collector

  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: vmagent
    network_mode: host
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - vmagent-data:/vmagentdata
    command:
      - '-promscrape.config=/etc/prometheus/prometheus.yml'
      - '-remoteWrite.url=http://localhost:8428/api/v1/write'
      - '-httpListenAddr=:8429'
    restart: unless-stopped
    depends_on:
      - victoriametrics
      - metrics-app

  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoriametrics
    network_mode: host
    volumes:
      - vmdata:/victoria-metrics-data
    command:
      - '-storageDataPath=/victoria-metrics-data'
      - '-retentionPeriod=12'
      - '-httpListenAddr=:8428'
    restart: unless-stopped

  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: victorialogs
    network_mode: host
    volumes:
      - ./data/victoria-logs:/victoria-logs-data
    command:
      - -retentionPeriod=7d
      - -storageDataPath=/victoria-logs-data
      - -httpListenAddr=:9428
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.136.0
    container_name: otel-collector
    network_mode: host
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    restart: unless-stopped
    depends_on:
      - victorialogs
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  vmdata:
  vmagent-data:
